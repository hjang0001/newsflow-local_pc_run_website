<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EconomyFlow</title>

<style>
/* --- SAME DESIGN SYSTEM AS NEWSFLOW --- */
:root {
  --bg:#f4f1ea; --card:#fff; --text:#2d2d2d; --title:#1a1a1a;
  --border:#d1d1d1; --highlight:#667eea;
  --success:#16a34a; --warning:#f59e0b; --danger:#dc2626;
}
body.dark-mode {
  --bg:#1a202c; --card:#2d3748; --text:#e2e8f0;
  --title:#fff; --border:#4a5568; --highlight:#63b3ed;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Georgia,serif;
  background:var(--bg);
  color:var(--text);
  padding:20px;
  line-height:1.6;
}
.container{max-width:1200px;margin:auto}

/* HEADER */
header{
  text-align:center;
  border-bottom:4px double var(--title);
  padding-bottom:20px;
  margin-bottom:30px;
  position:relative;
}
h1{font-size:3rem;letter-spacing:-1.5px}
.subtitle{
  font-family:sans-serif;
  font-weight:700;
  color:var(--highlight);
}
#timestamp{
  font-family:sans-serif;
  font-size:.8rem;
  opacity:.6;
  margin-top:6px;
}
.nav-link,.theme-btn{
  position:absolute;top:0;
  font-family:sans-serif;
  font-size:.85rem;
  font-weight:bold;
  padding:6px 12px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--highlight);
  border-radius:4px;
  cursor:pointer;
  text-decoration: none;
}
.nav-link{left:0;}
.theme-btn{right:0;color:var(--text)}

/* AI INTELLIGENCE BOX */
#global-intelligence-box{
  background:var(--card);
  border-left:8px solid var(--highlight);
  padding:25px;
  margin-bottom:35px;
  box-shadow:0 4px 8px rgba(0,0,0,.05);
}
.ai-title{
  font-family:sans-serif;
  font-size:1.2rem;
  font-weight:bold;
  color:var(--highlight);
  margin-bottom:5px;
}
.ai-sub{
  font-family:sans-serif; font-size:.9rem; opacity:.7; margin-bottom:15px; font-style:italic;
}
.impact{
  background:rgba(0,0,0,.03);
  padding:15px; margin-top:15px;
  border-left:4px solid var(--highlight);
  font-family:sans-serif; font-size:0.95rem;
}
.impact ul{margin-top:8px;padding-left:20px}

/* GRID LAYOUT */
#data-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(350px, 1fr));
  gap:25px;
}

/* CARDS */
.card{
  background:var(--card);
  border:1px solid var(--border);
  padding:20px;
  box-shadow:0 2px 4px rgba(0,0,0,.05);
}
.card h3{
  font-family:sans-serif;
  font-size:.9rem;
  letter-spacing:1px;
  color:var(--highlight);
  margin-bottom:15px;
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
  padding-bottom: 10px;
}

/* METRICS & TABLES */
.metric-row{
  display:flex; justify-content:space-between;
  padding:8px 0; border-bottom:1px solid var(--border);
  font-family:sans-serif; font-size:0.95rem;
}
.metric-row:last-child{border-bottom:none}
.metric-val{ font-family:monospace; font-weight:bold; font-size:1.1rem; }
.sub-val { font-size: 0.8rem; opacity: 0.7; font-weight: normal; margin-left: 5px; }

/* MINI TABLES FOR GLOBAL DATA */
.mini-table { width: 100%; border-collapse: collapse; font-family: sans-serif; font-size: 0.9rem; }
.mini-table td { padding: 6px 0; border-bottom: 1px solid var(--border); }
.mini-table td:last-child { text-align: right; font-family: monospace; font-weight: bold; }
.rank-num { color: var(--highlight); font-weight: bold; margin-right: 8px; }

/* RECESSION BADGE */
.risk-badge{
  display:inline-block; padding:5px 10px; border-radius:4px;
  font-family:sans-serif; font-size:.8rem; font-weight:bold;
  margin-top: 5px;
}
.risk-low{background:#d1fae5;color:#065f46}
.risk-moderate{background:#fef3c7;color:#92400e}
.risk-high{background:#fee2e2;color:#991b1b}
.risk-very-low{background:#d1fae5;color:#065f46}
.risk-critical{background:#fee2e2;color:#991b1b}

/* FX PAGINATION */
.fx-pagination { margin-top:12px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; font-family:sans-serif; font-size:.85rem; }
.fx-pagination button { padding:6px 14px; border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:4px; cursor:pointer; font-weight:bold; }
.fx-pagination button:hover { background:var(--highlight); color:#fff; border-color:var(--highlight); }
.fx-pagination button:disabled { opacity:.5; cursor:not-allowed; }
.fx-pagination .fx-page-info { opacity:.8; }

footer{ margin-top:50px; padding-top:20px; text-align:center; font-family:sans-serif; font-size:.8rem; opacity:.6; border-top:1px solid var(--border); }
</style>
</head>

<body>
<div class="container">
<header>
  <a href="index.html" class="nav-link">‚Üê Back</a>
  <h1>EconomyFlow</h1>
  <div class="subtitle">Macro Signals & Global FX Intelligence</div>
  <div id="timestamp">Loading data...</div>
  <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">Dark Mode</button>
</header>

<div id="global-intelligence-box">
  <div class="ai-title">ü§ñ AI Macro Outlook</div>
  <div class="ai-sub">GDP ¬∑ Labor ¬∑ Rates ¬∑ FX</div>
  <div id="ai-summary" style="font-size:1.1rem; margin-bottom:15px;">Loading analysis...</div>

  <div class="impact" style="border-left-color:var(--success)">
    <strong>What Matters Today</strong>
    <ul id="matters-list"></ul>
  </div>

  <div class="impact" style="border-left-color:var(--warning)">
    <strong>Strategic Outlook (3‚Äì6 Months)</strong>
    <p id="outlook-text" style="margin-top:5px"></p>
  </div>

  <div class="impact">
    <strong>Recommended Actions</strong>
    <ul id="action-list"></ul>
  </div>

  <div class="impact" id="market-pulse-box" style="display:none;">
    <strong>Market Pulse</strong>
    <p id="market-pulse-text" style="margin-top:5px"></p>
  </div>
</div>

<div id="data-grid">
  
  <div class="card">
    <h3>üá∫üá∏ U.S. Macro</h3>
    <div id="us-stats">Loading...</div>
  </div>

  <div class="card">
    <h3>üë∑ U.S. Labor</h3>
    <div id="labor-stats">Loading...</div>
  </div>

  <div class="card">
    <h3>üìâ Recession Risk</h3>
    <div style="text-align:center; padding:15px 0;">
      <div id="risk-score" style="font-size:3rem;font-weight:bold; line-height:1">‚Äî</div>
      <div id="risk-status" class="risk-badge">Calculating...</div>
      <p id="risk-reason" style="margin-top:10px; font-size:0.85rem; opacity:0.8; font-family:sans-serif; font-style:italic;">‚Äî</p>
    </div>
  </div>

  <div class="card">
    <h3>üõ¢Ô∏è Commodities</h3>
    <div id="commodities-stats">Loading...</div>
  </div>

  <div class="card">
    <h3>üìä Market Indexes</h3>
    <div id="indexes-stats">Loading...</div>
  </div>

  <div class="card">
    <h3>üìÖ Economic Calendar</h3>
    <div id="calendar-stats">Loading...</div>
  </div>

  <div class="card">
    <h3>üåç Top Economies</h3>
    <div id="global-gdp">Loading...</div>
  </div>

  <div class="card">
    <h3>üíº Best Job Markets</h3>
    <div id="global-jobs">Loading...</div>
  </div>

  <div class="card card-fx">
    <h3>üí± FX (vs USD)</h3>
    <div id="fx-stats">Loading...</div>
    <div id="fx-pagination" class="fx-pagination"></div>
  </div>

</div>
</div>

<footer>¬© 2026 NewsFlow AI</footer>

<script>
// 1. THEME LOGIC
const themeBtn = document.getElementById('themeBtn');
function toggleTheme(){
  document.body.classList.toggle('dark-mode');
  const d = document.body.classList.contains('dark-mode');
  localStorage.setItem('pref-theme', d);
  themeBtn.innerText = d ? "Light Mode" : "Dark Mode";
}
if(localStorage.getItem('pref-theme')==="true"){
  document.body.classList.add('dark-mode');
  themeBtn.innerText = "Light Mode";
}

// 2. HELPER FUNCTION
const get = (id) => document.getElementById(id);

// 3. BETTER AGGREGATE FILTER (Client-side backup)
const BAD_KEYWORDS = [
  'dividend', 'income', 'ibrd', 'ida', 'oecd', 'excluding', ' countries',
  'east asia', 'europe', 'latin america', 'caribbean', 'middle east',
  'north africa', 'south asia', 'sub-saharan', 'pacific', 'central asia',
  'arab', 'euro', 'union', 'baltics', 'afghanistan', 'pakistan', 'central europe'
];

function isRealCountry(name) {
  const nameLower = name.toLowerCase();
  return !BAD_KEYWORDS.some(keyword => nameLower.includes(keyword)) &&
         !name.includes('&') && 
         !name.includes('(');
}

// 4. DATA LOADING WITH DETAILED ERROR REPORTING
console.log('Starting data fetch...');

fetch(`economyflow.json?t=${Date.now()}`)
  .then(response => {
    console.log('Fetch response received:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  })
  .then(d => {
    console.log('JSON parsed successfully:', d);
    
    // Timestamp
    get('timestamp').innerText = "UPDATED: " + (d.last_updated_human || 'Unknown');

    // AI Section
    if(d.ai) {
        get('ai-summary').innerText = d.ai.connected_summary || 'No summary available';
        get('matters-list').innerHTML = (d.ai.what_matters_today || []).map(x=>`<li>${x}</li>`).join("") || '<li>No data</li>';
        get('action-list').innerHTML = (d.ai.what_to_do_next || []).map(x=>`<li>${x}</li>`).join("") || '<li>No actions</li>';
        get('outlook-text').innerText = d.ai.strategic_outlook || 'No outlook available';
        const mp = d.ai.market_pulse;
        if (mp) {
          get('market-pulse-text').innerText = mp;
          get('market-pulse-box').style.display = 'block';
        } else {
          get('market-pulse-box').style.display = 'none';
        }
    } else {
        get('ai-summary').innerText = "AI analysis unavailable";
        get('market-pulse-box').style.display = 'none';
        console.warn('No AI data in JSON');
    }

    // US Economy ‚Äî GDP rolling window, inflation, consumer sentiment
    if (d.us_economy) {
      const u = d.us_economy;
      const gq = u.gdp_growth_q || [];
      const gqStr = gq.length >= 4 ? `Q-3: ${gq[0]}%  Q-2: ${gq[1]}%  Q-1: ${gq[2]}%  Q0: ${gq[3]}%` : (u.gdp_growth != null ? `Q0: ${u.gdp_growth}%` : '‚Äî');
      const deltaQoq = u.gdp_growth_delta_qoq != null ? `Œî QoQ: ${u.gdp_growth_delta_qoq >= 0 ? '+' : ''}${u.gdp_growth_delta_qoq}` : '';
      const trend = u.gdp_growth_3q_trend ? `  3Q trend: ${u.gdp_growth_3q_trend}` : '';
      get('us-stats').innerHTML = `
        <div class="metric-row"><span>GDP growth (%)</span><span class="metric-val">${gqStr}</span></div>
        <div class="metric-row"><span>Œî QoQ / 3Q trend</span><span class="metric-val">${deltaQoq}${trend}</span></div>
        <div class="metric-row"><span>Unemployment</span><span class="metric-val">${u.unemployment ?? '--'}% <span class="sub-val">prev ${u.unemployment_prev ?? '--'}%</span></span></div>
        <div class="metric-row"><span>Inflation (annual)</span><span class="metric-val">${u.inflation ?? '--'}%</span></div>
        <div class="metric-row"><span>Interest Rate</span><span class="metric-val">${u.interest_rate ?? '--'}%</span></div>
        <div class="metric-row"><span>Yield Curve (10Y-2Y)</span><span class="metric-val">${u.yield_curve ?? '--'}% <span class="sub-val">(${d.derived_signals?.yield_curve_state || 'unknown'})</span></span></div>
        <div class="metric-row"><span>Consumer Sentiment</span><span class="metric-val">${u.consumer_sentiment ?? '--'}</span></div>
      `;
    } else {
      get('us-stats').innerHTML = '<p style="opacity:0.6">Data unavailable</p>';
      console.error('No us_economy data');
    }

    // US Labor ‚Äî current / prev / Œî / 3M avg (supports both object and scalar)
    const BLS_LABELS = {
      total_employment: 'Total Employment (thous.)',
      avg_hourly_earnings: 'Avg Hourly Earnings',
      financial_employment: 'Financial Activities',
      trade_transport_employment: 'Trade/Transportation',
      professional_employment: 'Professional Services',
      leisure_employment: 'Leisure/Hospitality',
      avg_weekly_hours: 'Avg Weekly Hours',
      job_openings: 'Job Openings (JOLTS)',
      retail_hourly_earnings: 'Retail Hourly Earnings',
      financial_hourly_earnings: 'Financial Hourly Earnings'
    };
    if (d.us_labor) {
      const rows = [];
      for (const [key, label] of Object.entries(BLS_LABELS)) {
        const v = d.us_labor[key];
        if (v == null) continue;
        if (typeof v === 'object' && v.current != null) {
          const cur = v.current; const prev = v.prev; const dAbs = v.delta_abs; const dPct = v.delta_pct; const threeM = v.change_3m_avg_pct;
          const pctStr = dPct != null ? ` (${dPct >= 0 ? '+' : ''}${dPct}%)` : '';
          const threeMStr = threeM != null ? `  3M avg: ${threeM >= 0 ? '+' : ''}${threeM}%` : '';
          rows.push(`<div class="metric-row"><span>${label}</span><span class="metric-val">${typeof cur === 'number' && cur > 1000 ? cur.toLocaleString('en-US', {maximumFractionDigits:0}) : cur} <span class="sub-val">prev ${prev ?? '‚Äî'}  Œî ${dAbs != null ? (dAbs >= 0 ? '+' : '') + dAbs : '‚Äî'}${pctStr}${threeMStr}</span></span></div>`);
        } else {
          rows.push(`<div class="metric-row"><span>${label}</span><span class="metric-val">${v}</span></div>`);
        }
      }
      get('labor-stats').innerHTML = rows.length ? rows.join('') : '<p style="opacity:0.6">No labor data</p>';
    } else {
      get('labor-stats').innerHTML = '<p style="opacity:0.6">Data unavailable</p>';
      console.error('No us_labor data');
    }

    // Recession
    if (d.recession_analysis) {
      const r = d.recession_analysis;
      get('risk-score').innerText = r.risk_score || '--';
      get('risk-reason').innerText = r.reason || 'No analysis';
      const rBadge = get('risk-status');
      rBadge.innerText = r.status || 'UNKNOWN';
      rBadge.className = `risk-badge risk-${(r.status || 'unknown').toLowerCase().replace(/ /g, '-')}`;
    } else {
      console.error('No recession_analysis data');
    }

    // Commodities ‚Äî unit, price, prev, change
    if (d.commodities && Object.keys(d.commodities).length > 0) {
      get('commodities-stats').innerHTML = Object.entries(d.commodities).map(([name, o]) => {
        const unit = o.unit || ''; const price = o.price; const prev = o.prev; const ch = o.change;
        const chStr = ch != null ? ` Œî ${ch >= 0 ? '+' : ''}${ch}%` : '';
        return `<div class="metric-row"><span>${name} (${unit})</span><span class="metric-val">${price ?? '‚Äî'} <span class="sub-val">prev ${prev ?? '‚Äî'}${chStr}</span></span></div>`;
      }).join('');
    } else {
      get('commodities-stats').innerHTML = '<p style="opacity:0.6">No commodities data</p>';
    }

    // Market Indexes ‚Äî price, 30D ago, Œî 30D
    if (d.market_indexes && Object.keys(d.market_indexes).length > 0) {
      get('indexes-stats').innerHTML = Object.entries(d.market_indexes).map(([name, o]) => {
        const price = o.price; const p30 = o.price_30d_ago; const c30 = o.change_30d;
        const c30Str = c30 != null ? ` Œî 30D: ${c30 >= 0 ? '+' : ''}${c30}%` : '';
        return `<div class="metric-row"><span>${name}</span><span class="metric-val">${price ?? '‚Äî'} <span class="sub-val">30D ago ${p30 ?? '‚Äî'}${c30Str}</span></span></div>`;
      }).join('');
    } else {
      get('indexes-stats').innerHTML = '<p style="opacity:0.6">No index data</p>';
    }

    // Economic Calendar
    if (d.economic_calendar && d.economic_calendar.length > 0) {
      get('calendar-stats').innerHTML = d.economic_calendar.slice(0, 8).map(ev => 
        `<div class="metric-row"><span>${ev.event || 'Event'}</span><span class="metric-val">${ev.date || '‚Äî'} <span class="sub-val">${ev.actual || ''}</span></span></div>`
      ).join('');
    } else {
      get('calendar-stats').innerHTML = '<p style="opacity:0.6">No calendar data</p>';
    }

    // Global GDP ‚Äî YoY, rank change, WITH FILTERING
    if (d.global && d.global.top_economies) {
      const realCountries = d.global.top_economies.filter(c => isRealCountry(c.country)).slice(0, 8);
      if (realCountries.length > 0) {
        get('global-gdp').innerHTML = `<table class="mini-table">` + realCountries.map((c, i) => {
          const g = c.gdp_billions; const yoy = c.gdp_yoy_pct; const dr = c.gdp_delta_rank;
          const rankChg = dr != null && dr !== 0 ? ` Œîrank ${dr > 0 ? '+' : ''}${dr}` : ' rank stable';
          const yoyStr = yoy != null ? ` Œî YoY ${yoy >= 0 ? '+' : ''}${yoy}%` : '';
          return `<tr><td><span class="rank-num">#${(c.gdp_rank || i+1)}</span> ${c.country}</td><td>$${g != null ? (g/1000).toFixed(1) : '‚Äî'}T ${yoyStr} ${rankChg}</td></tr>`;
        }).join("") + `</table>`;
      } else {
        get('global-gdp').innerHTML = '<p style="opacity:0.6; text-align:center">No real countries found</p>';
      }
    } else {
      get('global-gdp').innerHTML = '<p style="opacity:0.6">Data unavailable</p>';
    }

    // Global Jobs ‚Äî unemployment, Œî, Œî rank, WITH FILTERING
    if (d.global && d.global.best_for_jobs) {
      const realJobCountries = d.global.best_for_jobs.filter(c => isRealCountry(c.country) && c.unemployment_rate != null).slice(0, 8);
      if (realJobCountries.length > 0) {
        get('global-jobs').innerHTML = `<table class="mini-table">` + realJobCountries.map((c, i) => {
          const u = c.unemployment_rate; const dU = c.unemployment_delta; const dr = c.unemployment_delta_rank;
          const dStr = dU != null ? ` Œî ${dU >= 0 ? '+' : ''}${dU}` : ''; const rankChg = dr != null && dr !== 0 ? ` Œîrank ${dr > 0 ? '+' : ''}${dr}` : ' stable';
          return `<tr><td><span class="rank-num">#${c.unemployment_rank || (i+1)}</span> ${c.country}</td><td>${u.toFixed(1)}% ${dStr} ${rankChg}</td></tr>`;
        }).join("") + `</table>`;
      } else {
        get('global-jobs').innerHTML = '<p style="opacity:0.6; text-align:center">No job data</p>';
      }
    } else {
      get('global-jobs').innerHTML = '<p style="opacity:0.6">Data unavailable</p>';
    }

    // FX ‚Äî paginated (10 per page)
    const FX_PAGE_SIZE = 10;
    if (d.fx_rates && Object.keys(d.fx_rates).length > 0) {
      const fxEntries = Object.entries(d.fx_rates);
      let fxPage = 0;
      const totalFxPages = Math.ceil(fxEntries.length / FX_PAGE_SIZE);
      function renderFxPage() {
        const start = fxPage * FX_PAGE_SIZE;
        const slice = fxEntries.slice(start, start + FX_PAGE_SIZE);
        get('fx-stats').innerHTML = slice.map(([k,v]) => `<div class="metric-row"><span>${k}</span><span class="metric-val">${v}</span></div>`).join("");
        const pag = get('fx-pagination');
        pag.innerHTML = `
          <button type="button" ${fxPage === 0 ? 'disabled' : ''} onclick="window.prevFxPage()">‚Üê Prev</button>
          <span class="fx-page-info">Page ${fxPage + 1} of ${totalFxPages} (${fxEntries.length} pairs)</span>
          <button type="button" ${fxPage >= totalFxPages - 1 ? 'disabled' : ''} onclick="window.nextFxPage()">Next ‚Üí</button>
        `;
      }
      window.prevFxPage = () => { if (fxPage > 0) { fxPage--; renderFxPage(); } };
      window.nextFxPage = () => { if (fxPage < totalFxPages - 1) { fxPage++; renderFxPage(); } };
      renderFxPage();
    } else {
      get('fx-stats').innerHTML = '<p style="opacity:0.6">FX data unavailable</p>';
      get('fx-pagination').innerHTML = '';
    }

    console.log('‚úÖ All data loaded successfully');

  })
  .catch(e => {
      console.error('‚ùå ERROR:', e);
      get('timestamp').innerText = "ERROR: " + e.message;
      get('ai-summary').innerHTML = `
        <div style="color:var(--danger); padding:15px; background:rgba(220,38,38,0.1); border-radius:5px;">
          <strong>Data Loading Failed</strong><br>
          ${e.message}<br><br>
          Check browser console (F12) for details.
        </div>
      `;
  });
</script>
</body>
</html>